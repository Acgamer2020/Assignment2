<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap"
      rel="stylesheet"
    />
    <title>Product Management</title>
    <style>
      /* General styles */
      * {
        margin: 0;
        box-sizing: border-box;
      }
      body {
        font-family: Roboto, "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: rgb(13, 13, 13);
        background-color: rgb(245, 250, 255);
      }
      .header {
        position: sticky;
        top: 0;
        padding: 0.7rem 0.5rem;
        display: flex;
        justify-content: right;
        background-color: rgb(30, 48, 185);
        box-shadow: rgba(149, 157, 165, 0.2) 0px 8px 24px;
      }
      .sidebar {
        position: fixed;
        height: 100vh;
        width: 30vh;
        background-color: rgb(60, 76, 203);
      }
      .sidebar a {
        color: #ffffff;
        display: block;
        text-decoration: none;
        padding: 0.8rem 0;
        padding-left: 1.5rem;
        border-bottom: 0.1rem solid rgb(50, 66, 189);
      }
      .section-container {
        background-color: #ffffff;
        min-width: 60vw;
        margin: 0.2rem 0;
        padding: 0.1rem 1rem;
        box-shadow: rgba(0, 0, 0, 0.16) 0px 1px 4px;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
      }
      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }
      .product-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      .product-table th,
      .product-table td {
        border: 1px solid #ccc;
        padding: 10px;
        text-align: left;
      }
      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .btn-confirm {
        background-color: #e74c3c;
        color: white;
      }
      .btn-cancel {
        background-color: #95a5a6;
        color: white;
      }
    </style>
  </head>
  <body>
    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h3>Confirm Deletion</h3>
        <p>Are you sure you want to delete this product?</p>
        <div class="modal-buttons">
          <button class="btn btn-cancel">Cancel</button>
          <button class="btn btn-confirm">Delete</button>
        </div>
      </div>
    </div>

    <div class="header">
      <h3>Product Management</h3>
    </div>
    <div class="container">
      <div class="sidebar" id="sidebar">
        <a href="dashboard.html"><i class="fa fa-home"></i> Dashboard</a>
        <a href="form.html"><i class="fa fa-shopping-cart"></i> Forms</a>
        <a href="tables.html"><i class="fa fa-shopping-bag"></i> Tables</a>
      </div>
      <div class="content">
        <div class="left">
          <h3>Product Records</h3>
          <div class="section-container">
            <div class="section-header">Details of available products</div>
            <div class="section-content">
              <div class="loader-text">Loading products...</div>
            </div>
          </div>

          <!-- Edit Form -->
          <div
            id="editFormContainer"
            class="edit-form-container section-container"
          >
            <div class="section-header">Edit Product</div>
            <form id="editProductForm">
              <input type="hidden" id="editProductId" />
              <label for="editName" class="label">Product Name</label>
              <input type="text" id="editName" required />
              <label for="editPrice" class="label">Price</label>
              <input type="number" id="editPrice" step="0.01" required />
              <label for="editQuantity" class="label">Quantity</label>
              <input type="number" id="editQuantity" required />
              <label for="editDescription" class="label">Description</label>
              <textarea id="editDescription" rows="3"></textarea>
              <button type="submit" class="form-button primary">
                Update Product
              </button>
              <button type="button" id="cancelEdit" class="form-button">
                Cancel
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      $(document).ready(() => {
        const sectionContent = $(".section-content");
        let products = [];
        let productToDelete = null;

        const deleteModal = $("#deleteModal");
        const closeModal = $(".close");
        const cancelDelete = $(".btn-cancel");
        const confirmDelete = $(".btn-confirm");

        const editFormContainer = $("#editFormContainer");
        const editProductForm = $("#editProductForm");
        const cancelEditBtn = $("#cancelEdit");

        closeModal.on("click", () => deleteModal.hide());
        cancelDelete.on("click", () => deleteModal.hide());
        confirmDelete.on("click", () => {
          if (productToDelete) deleteProduct(productToDelete.id);
        });
        $(window).on("click", (e) => {
          if (e.target == deleteModal[0]) deleteModal.hide();
        });

        cancelEditBtn.on("click", () => editFormContainer.hide());
        editProductForm.on("submit", (e) => {
          e.preventDefault();
          updateProduct();
        });

        loadProducts();

        function loadProducts() {
          sectionContent.html(
            "<div class='loader-text'>Loading products...</div>"
          );
          fetch("http://localhost:3000/products")
            .then((res) => res.json())
            .then((data) => {
              products = data;
              renderProductsTable();
            })
            .catch(() => {
              sectionContent.html("<p>Error loading products.</p>");
            });
        }

        function renderProductsTable() {
          const table = $("<table class='product-table'></table>");
          const thead = `
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>`;
          table.append(thead);

          const tbody = $("<tbody></tbody>");
          products.forEach((p) => {
            const row = `
                    <tr>
                        <td>${p.name}</td>
                        <td>$${p.price}</td>
                        <td>${p.quantity}</td>
                        <td>${p.description}</td>
                        <td>
                            <button class="edit-btn" data-id="${p.id}">Edit</button>
                            <button class="delete-btn" data-id="${p.id}">Delete</button>
                        </td>
                    </tr>`;
            tbody.append(row);
          });
          table.append(tbody);
          sectionContent.html(table);

          $(".edit-btn").on("click", function () {
            editProduct($(this).data("id"));
          });
          $(".delete-btn").on("click", function () {
            showDeleteModal($(this).data("id"));
          });
        }

        function showDeleteModal(id) {
          productToDelete = products.find((p) => p.id == id);
          if (productToDelete) {
            $("#deleteModal p").text(
              `Are you sure you want to delete "${productToDelete.name}"?`
            );
            deleteModal.show();
          }
        }

        function deleteProduct(id) {
          fetch(`http://localhost:3000/products/${id}`, { method: "DELETE" })
            .then((res) => {
              if (res.ok) {
                products = products.filter((p) => p.id != id);
                renderProductsTable();
                deleteModal.hide();
              } else alert("Error deleting product.");
            })
            .catch(() => alert("Error deleting product."));
        }

        function editProduct(id) {
          const p = products.find((x) => x.id == id);
          if (p) {
            $("#editProductId").val(p.id);
            $("#editName").val(p.name);
            $("#editPrice").val(p.price);
            $("#editQuantity").val(p.quantity);
            $("#editDescription").val(p.description);
            editFormContainer.show();
            $("html, body").animate(
              { scrollTop: editFormContainer.offset().top },
              500
            );
          }
        }

        function updateProduct() {
          const id = $("#editProductId").val();
          const updated = {
            id: parseInt(id), // include ID in body
            name: $("#editName").val(),
            price: parseFloat($("#editPrice").val()),
            quantity: parseInt($("#editQuantity").val()),
            description: $("#editDescription").val(),
          };
          fetch(`http://localhost:3000/products`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updated),
          })
            .then((res) => {
              if (res.ok) {
                const i = products.findIndex((p) => p.id == id);
                if (i !== -1) products[i] = { ...products[i], ...updated };
                renderProductsTable();
                editFormContainer.hide();
                alert("Product updated successfully!");
              } else alert("Error updating product.");
            })
            .catch(() => alert("Error updating product."));
        }
      });
    </script>
  </body>
</html>
